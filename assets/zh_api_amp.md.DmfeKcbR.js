import{_ as s,c as a,o as e,ah as i}from"./chunks/framework.DJtYh1Hc.js";const n=JSON.parse('{"title":"tensorplay.amp","description":"","frontmatter":{},"headers":[],"relativePath":"zh/api/amp.md","filePath":"zh/api/amp.md"}');const t=s({name:"zh/api/amp.md"},[["render",function(s,n,t,l,o,r){return e(),a("div",null,[...n[0]||(n[0]=[i('<div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>该页面尚未翻译。 以下内容为英文原版。</p></div><h1 id="tensorplay-amp" tabindex="-1">tensorplay.amp <a class="header-anchor" href="#tensorplay-amp" aria-label="Permalink to &quot;tensorplay.amp&quot;">​</a></h1><h2 id="classes" tabindex="-1">Classes <a class="header-anchor" href="#classes" aria-label="Permalink to &quot;Classes&quot;">​</a></h2><h3 id="class-gradscaler-source" tabindex="-1"><code>class GradScaler</code> <a href="https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L54" target="_blank" rel="noreferrer">[source]</a> <a class="header-anchor" href="#class-gradscaler-source" aria-label="Permalink to &quot;`class GradScaler` [[source]](https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L54)&quot;">​</a></h3><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">GradScaler(device: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;str&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;cpu&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, init_scale: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;float&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 65536.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, growth_factor: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;float&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, backoff_factor: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;float&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, growth_interval: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;int&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, enabled: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;bool&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;None&#39;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>An instance <code>scaler</code> of <code>GradScaler</code>.</p><p>Helps perform the steps of gradient scaling conveniently.</p><ul><li><code>scaler.scale(loss)</code> multiplies a given loss by <code>scaler</code>&#39;s current scale factor.</li><li><code>scaler.step(optimizer)</code> safely unscales gradients and calls <code>optimizer.step()</code>.</li><li><code>scaler.update()</code> updates <code>scaler</code>&#39;s scale factor.</li></ul><h4 id="example" tabindex="-1">Example <a class="header-anchor" href="#example" aria-label="Permalink to &quot;Example&quot;">​</a></h4><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Creates a GradScaler once at the beginning of training.</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">scaler </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> GradScaler()</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> epoch </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> epochs:</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> input</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, target </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data:</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        optimizer.zero_grad()</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        output </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> model(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">input</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        loss </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> loss_fn(output, target)</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # Scales loss.  Calls backward() on scaled loss to create scaled gradients.</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        scaler.scale(loss).backward()</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # scaler.step() first unscales gradients of the optimizer&#39;s params.</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # If gradients don&#39;t contain infs/NaNs, optimizer.step() is then called,</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # otherwise, optimizer.step() is skipped.</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        scaler.step(optimizer)</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # Updates the scale for next iteration.</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        scaler.update()</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>See the <code>Automatic Mixed Precision examples&lt;amp-examples&gt;</code> for usage (along with autocasting) in more complex cases like gradient clipping, gradient accumulation, gradient penalty, and multiple losses/optimizers.</p><p><code>scaler</code> dynamically estimates the scale factor each iteration. To minimize gradient underflow, a large scale factor should be used. However, <code>float16</code> values can &quot;overflow&quot; (become inf or NaN) if the scale factor is too large. Therefore, the optimal scale factor is the largest factor that can be used without incurring inf or NaN gradient values. <code>scaler</code> approximates the optimal scale factor over time by checking the gradients for infs and NaNs during every <code>scaler.step(optimizer)</code> (or optional separate <code>scaler.unscale_(optimizer)</code>, see <code>unscale_</code>).</p><ul><li><p>If infs/NaNs are found, <code>scaler.step(optimizer)</code> skips the underlying <code>optimizer.step()</code> (so the params themselves remain uncorrupted) and <code>update()</code> multiplies the scale by <code>backoff_factor</code>.</p></li><li><p>If no infs/NaNs are found, <code>scaler.step(optimizer)</code> runs the underlying <code>optimizer.step()</code> as usual. If <code>growth_interval</code> unskipped iterations occur consecutively, <code>update()</code> multiplies the scale by <code>growth_factor</code>.</p></li></ul><p>The scale factor often causes infs/NaNs to appear in gradients for the first few iterations as its value calibrates. <code>scaler.step</code> will skip the underlying <code>optimizer.step()</code> for these iterations. After that, step skipping should occur rarely (once every few hundred or thousand iterations).</p><h4 id="args" tabindex="-1">Args <a class="header-anchor" href="#args" aria-label="Permalink to &quot;Args&quot;">​</a></h4><ul><li><strong>device</strong> (<code>str, optional, default=&quot;cuda&quot;</code>): Device type to use. Possible values are: &#39;cuda&#39; and &#39;cpu&#39;. The type is the same as the <code>type</code> attribute of a <code>torch.device</code>. Thus, you may obtain the device type of a tensor using <code>Tensor.device.type</code>.</li><li><strong>init_scale</strong> (<code>float, optional, default=2.**16</code>): Initial scale factor.</li><li><strong>growth_factor</strong> (<code>float, optional, default=2.0</code>): Factor by which the scale is multiplied during <code>update</code> if no inf/NaN gradients occur for <code>growth_interval</code> consecutive iterations.</li><li><strong>backoff_factor</strong> (<code>float, optional, default=0.5</code>): Factor by which the scale is multiplied during <code>update</code> if inf/NaN gradients occur in an iteration.</li><li><strong>growth_interval</strong> (<code>int, optional, default=2000</code>): Number of consecutive iterations without inf/NaN gradients that must occur for the scale to be multiplied by <code>growth_factor</code>.</li><li><strong>enabled</strong> (<code>bool, optional</code>): If <code>False</code>, disables gradient scaling. <code>step</code> simply invokes the underlying <code>optimizer.step()</code>, and other methods become no-ops.</li><li><strong>Default</strong>: <code>True</code></li></ul><details><summary>Methods</summary><h4 id="init-self-device-str-cpu-init-scale-float-65536-0-growth-factor-float-2-0-backoff-factor-float-0-5-growth-interval-int-2000-enabled-bool-true-none-source" tabindex="-1"><code>__init__(self, device: &#39;str&#39; = &#39;cpu&#39;, init_scale: &#39;float&#39; = 65536.0, growth_factor: &#39;float&#39; = 2.0, backoff_factor: &#39;float&#39; = 0.5, growth_interval: &#39;int&#39; = 2000, enabled: &#39;bool&#39; = True) -&gt; &#39;None&#39;</code> <a href="https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L124" target="_blank" rel="noreferrer">[source]</a> <a class="header-anchor" href="#init-self-device-str-cpu-init-scale-float-65536-0-growth-factor-float-2-0-backoff-factor-float-0-5-growth-interval-int-2000-enabled-bool-true-none-source" aria-label="Permalink to &quot;`__init__(self, device: &#39;str&#39; = &#39;cpu&#39;, init_scale: &#39;float&#39; = 65536.0, growth_factor: &#39;float&#39; = 2.0, backoff_factor: &#39;float&#39; = 0.5, growth_interval: &#39;int&#39; = 2000, enabled: &#39;bool&#39; = True) -&gt; &#39;None&#39;` [[source]](https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L124)&quot;">​</a></h4><p>Initialize self. See help(type(self)) for accurate signature.</p><hr><h4 id="get-backoff-factor-self-float-source" tabindex="-1"><code>get_backoff_factor(self) -&gt; &#39;float&#39;</code> <a href="https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L572" target="_blank" rel="noreferrer">[source]</a> <a class="header-anchor" href="#get-backoff-factor-self-float-source" aria-label="Permalink to &quot;`get_backoff_factor(self) -&gt; &#39;float&#39;` [[source]](https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L572)&quot;">​</a></h4><p>Return a Python float containing the scale backoff factor.</p><hr><h4 id="get-growth-factor-self-float-source" tabindex="-1"><code>get_growth_factor(self) -&gt; &#39;float&#39;</code> <a href="https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L560" target="_blank" rel="noreferrer">[source]</a> <a class="header-anchor" href="#get-growth-factor-self-float-source" aria-label="Permalink to &quot;`get_growth_factor(self) -&gt; &#39;float&#39;` [[source]](https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L560)&quot;">​</a></h4><p>Return a Python float containing the scale growth factor.</p><hr><h4 id="get-growth-interval-self-int-source" tabindex="-1"><code>get_growth_interval(self) -&gt; &#39;int&#39;</code> <a href="https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L584" target="_blank" rel="noreferrer">[source]</a> <a class="header-anchor" href="#get-growth-interval-self-int-source" aria-label="Permalink to &quot;`get_growth_interval(self) -&gt; &#39;int&#39;` [[source]](https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L584)&quot;">​</a></h4><p>Return a Python int containing the growth interval.</p><hr><h4 id="get-scale-self-float-source" tabindex="-1"><code>get_scale(self) -&gt; &#39;float&#39;</code> <a href="https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L546" target="_blank" rel="noreferrer">[source]</a> <a class="header-anchor" href="#get-scale-self-float-source" aria-label="Permalink to &quot;`get_scale(self) -&gt; &#39;float&#39;` [[source]](https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L546)&quot;">​</a></h4><p>Return a Python float containing the current scale, or 1.0 if scaling is disabled.</p><div class="danger custom-block"><p class="custom-block-title">DANGER</p><p><code>get_scale</code> incurs a CPU-GPU sync.</p></div><hr><h4 id="is-enabled-self-bool-source" tabindex="-1"><code>is_enabled(self) -&gt; &#39;bool&#39;</code> <a href="https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L605" target="_blank" rel="noreferrer">[source]</a> <a class="header-anchor" href="#is-enabled-self-bool-source" aria-label="Permalink to &quot;`is_enabled(self) -&gt; &#39;bool&#39;` [[source]](https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L605)&quot;">​</a></h4><p>Return a bool indicating whether this instance is enabled.</p><hr><h4 id="load-state-dict-self-state-dict-dict-str-any-none-source" tabindex="-1"><code>load_state_dict(self, state_dict: &#39;dict[str, Any]&#39;) -&gt; &#39;None&#39;</code> <a href="https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L636" target="_blank" rel="noreferrer">[source]</a> <a class="header-anchor" href="#load-state-dict-self-state-dict-dict-str-any-none-source" aria-label="Permalink to &quot;`load_state_dict(self, state_dict: &#39;dict[str, Any]&#39;) -&gt; &#39;None&#39;` [[source]](https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L636)&quot;">​</a></h4><p>Load the scaler state.</p><p>If this instance is disabled, <code>load_state_dict</code> is a no-op.</p><h4 id="args-1" tabindex="-1">Args <a class="header-anchor" href="#args-1" aria-label="Permalink to &quot;Args&quot;">​</a></h4><p>state_dict(dict): scaler state. Should be an object returned from a call to <code>state_dict</code>.</p><hr><h4 id="scale-self-outputs-union-tensorplay-tensor-iterable-tensorplay-tensor-union-tensorplay-tensor-iterable-tensorplay-tensor-source" tabindex="-1"><code>scale(self, outputs: &#39;Union[tensorplay.Tensor, Iterable[tensorplay.Tensor]]&#39;) -&gt; &#39;Union[tensorplay.Tensor, Iterable[tensorplay.Tensor]]&#39;</code> <a href="https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L195" target="_blank" rel="noreferrer">[source]</a> <a class="header-anchor" href="#scale-self-outputs-union-tensorplay-tensor-iterable-tensorplay-tensor-union-tensorplay-tensor-iterable-tensorplay-tensor-source" aria-label="Permalink to &quot;`scale(self, outputs: &#39;Union[tensorplay.Tensor, Iterable[tensorplay.Tensor]]&#39;) -&gt; &#39;Union[tensorplay.Tensor, Iterable[tensorplay.Tensor]]&#39;` [[source]](https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L195)&quot;">​</a></h4><p>Multiplies (&#39;scales&#39;) a tensor or list of tensors by the scale factor.</p><p>Returns scaled outputs. If this instance of <code>GradScaler</code> is not enabled, outputs are returned unmodified.</p><h4 id="args-2" tabindex="-1">Args <a class="header-anchor" href="#args-2" aria-label="Permalink to &quot;Args&quot;">​</a></h4><ul><li><strong>outputs</strong> (<code>Tensor or iterable of Tensors</code>): Outputs to scale.</li></ul><hr><h4 id="set-backoff-factor-self-new-factor-float-none-source" tabindex="-1"><code>set_backoff_factor(self, new_factor: &#39;float&#39;) -&gt; &#39;None&#39;</code> <a href="https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L576" target="_blank" rel="noreferrer">[source]</a> <a class="header-anchor" href="#set-backoff-factor-self-new-factor-float-none-source" aria-label="Permalink to &quot;`set_backoff_factor(self, new_factor: &#39;float&#39;) -&gt; &#39;None&#39;` [[source]](https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L576)&quot;">​</a></h4><p>Set a new scale backoff factor.</p><h4 id="args-3" tabindex="-1">Args <a class="header-anchor" href="#args-3" aria-label="Permalink to &quot;Args&quot;">​</a></h4><ul><li><strong>new_scale</strong> (<code>float</code>): Value to use as the new scale backoff factor.</li></ul><hr><h4 id="set-growth-factor-self-new-factor-float-none-source" tabindex="-1"><code>set_growth_factor(self, new_factor: &#39;float&#39;) -&gt; &#39;None&#39;</code> <a href="https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L564" target="_blank" rel="noreferrer">[source]</a> <a class="header-anchor" href="#set-growth-factor-self-new-factor-float-none-source" aria-label="Permalink to &quot;`set_growth_factor(self, new_factor: &#39;float&#39;) -&gt; &#39;None&#39;` [[source]](https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L564)&quot;">​</a></h4><p>Set a new scale growth factor.</p><h4 id="args-4" tabindex="-1">Args <a class="header-anchor" href="#args-4" aria-label="Permalink to &quot;Args&quot;">​</a></h4><ul><li><strong>new_scale</strong> (<code>float</code>): Value to use as the new scale growth factor.</li></ul><hr><h4 id="set-growth-interval-self-new-interval-int-none-source" tabindex="-1"><code>set_growth_interval(self, new_interval: &#39;int&#39;) -&gt; &#39;None&#39;</code> <a href="https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L588" target="_blank" rel="noreferrer">[source]</a> <a class="header-anchor" href="#set-growth-interval-self-new-interval-int-none-source" aria-label="Permalink to &quot;`set_growth_interval(self, new_interval: &#39;int&#39;) -&gt; &#39;None&#39;` [[source]](https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L588)&quot;">​</a></h4><p>Set a new growth interval.</p><h4 id="args-5" tabindex="-1">Args <a class="header-anchor" href="#args-5" aria-label="Permalink to &quot;Args&quot;">​</a></h4><ul><li><strong>new_interval</strong> (<code>int</code>): Value to use as the new growth interval.</li></ul><hr><h4 id="state-dict-self-dict-str-any-source" tabindex="-1"><code>state_dict(self) -&gt; &#39;dict[str, Any]&#39;</code> <a href="https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L609" target="_blank" rel="noreferrer">[source]</a> <a class="header-anchor" href="#state-dict-self-dict-str-any-source" aria-label="Permalink to &quot;`state_dict(self) -&gt; &#39;dict[str, Any]&#39;` [[source]](https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L609)&quot;">​</a></h4><p>Return the state of the scaler as a <code>dict</code>.</p><p>It contains five entries:</p><ul><li><code>&quot;scale&quot;</code> - a Python float containing the current scale</li><li><code>&quot;growth_factor&quot;</code> - a Python float containing the current growth factor</li><li><code>&quot;backoff_factor&quot;</code> - a Python float containing the current backoff factor</li><li><code>&quot;growth_interval&quot;</code> - a Python int containing the current growth interval</li><li><code>&quot;_growth_tracker&quot;</code> - a Python int containing the number of recent consecutive unskipped steps.</li></ul><p>If this instance is not enabled, returns an empty dict.</p><p>.. note:: If you wish to checkpoint the scaler&#39;s state after a particular iteration, <code>state_dict</code> should be called after <code>update</code>.</p><hr><h4 id="step-self-optimizer-tensorplay-optim-optimizer-args-any-kwargs-any-optional-float-source" tabindex="-1"><code>step(self, optimizer: &#39;tensorplay.optim.Optimizer&#39;, *args: &#39;Any&#39;, **kwargs: &#39;Any&#39;) -&gt; &#39;Optional[float]&#39;</code> <a href="https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L365" target="_blank" rel="noreferrer">[source]</a> <a class="header-anchor" href="#step-self-optimizer-tensorplay-optim-optimizer-args-any-kwargs-any-optional-float-source" aria-label="Permalink to &quot;`step(self, optimizer: &#39;tensorplay.optim.Optimizer&#39;, *args: &#39;Any&#39;, **kwargs: &#39;Any&#39;) -&gt; &#39;Optional[float]&#39;` [[source]](https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L365)&quot;">​</a></h4><p>Invoke <code>unscale_(optimizer)</code> followed by parameter update, if gradients are not infs/NaN.</p><p><code>step</code> carries out the following two operations:</p><ol><li>Internally invokes <code>unscale_(optimizer)</code> (unless <code>unscale_</code> was explicitly called for <code>optimizer</code> earlier in the iteration). As part of the <code>unscale_</code>, gradients are checked for infs/NaNs.</li><li>If no inf/NaN gradients are found, invokes <code>optimizer.step()</code> using the unscaled gradients. Otherwise, <code>optimizer.step()</code> is skipped to avoid corrupting the params.</li></ol><p><code>*args</code> and <code>**kwargs</code> are forwarded to <code>optimizer.step()</code>.</p><p>Returns the return value of <code>optimizer.step(*args, **kwargs)</code>.</p><h4 id="args-6" tabindex="-1">Args <a class="header-anchor" href="#args-6" aria-label="Permalink to &quot;Args&quot;">​</a></h4><ul><li><strong>optimizer</strong> (<code>tensorplay.optim.Optimizer</code>): Optimizer that applies the gradients.</li><li><strong>args</strong>: Any arguments.</li><li><strong>kwargs</strong>: Any keyword arguments.</li></ul><div class="danger custom-block"><p class="custom-block-title">DANGER</p><p>Closure use is not currently supported.</p></div><hr><h4 id="unscale-self-optimizer-tensorplay-optim-optimizer-none-source" tabindex="-1"><code>unscale_(self, optimizer: &#39;tensorplay.optim.Optimizer&#39;) -&gt; &#39;None&#39;</code> <a href="https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L293" target="_blank" rel="noreferrer">[source]</a> <a class="header-anchor" href="#unscale-self-optimizer-tensorplay-optim-optimizer-none-source" aria-label="Permalink to &quot;`unscale_(self, optimizer: &#39;tensorplay.optim.Optimizer&#39;) -&gt; &#39;None&#39;` [[source]](https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L293)&quot;">​</a></h4><p>Divides (&quot;unscales&quot;) the optimizer&#39;s gradient tensors by the scale factor.</p><p><code>unscale_</code> is optional, serving cases where you need to <code>modify or inspect gradients&lt;working-with-unscaled-gradients&gt;</code> between the backward pass(es) and <code>step</code>. If <code>unscale_</code> is not called explicitly, gradients will be unscaled automatically during <code>step</code>.</p><p>Simple example, using <code>unscale_</code> to enable clipping of unscaled gradients</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">scaler.scale(loss).backward()</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">scaler.unscale_(optimizer)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">torch.nn.utils.clip_grad_norm_(model.parameters(), max_norm)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">scaler.step(optimizer)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">scaler.update()</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="args-7" tabindex="-1">Args <a class="header-anchor" href="#args-7" aria-label="Permalink to &quot;Args&quot;">​</a></h4><ul><li><strong>optimizer</strong> (<code>torch.optim.Optimizer</code>): Optimizer that owns the gradients to be unscaled.</li></ul><div class="info custom-block"><p class="custom-block-title">INFO</p><p><code>unscale_</code> does not incur a CPU-GPU sync.</p></div><div class="danger custom-block"><p class="custom-block-title">DANGER</p><p><code>unscale_</code> should only be called once per optimizer per <code>step</code> call, and only after all gradients for that optimizer&#39;s assigned parameters have been accumulated. Calling <code>unscale_</code> twice for a given optimizer between each <code>step</code> triggers a RuntimeError.</p></div><div class="danger custom-block"><p class="custom-block-title">DANGER</p><p><code>unscale_</code> may unscale sparse gradients out of place, replacing the <code>.grad</code> attribute.</p></div><hr><h4 id="update-self-new-scale-optional-union-float-tensorplay-tensor-none-none-source" tabindex="-1"><code>update(self, new_scale: &#39;Optional[Union[float, tensorplay.Tensor]]&#39; = None) -&gt; &#39;None&#39;</code> <a href="https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L473" target="_blank" rel="noreferrer">[source]</a> <a class="header-anchor" href="#update-self-new-scale-optional-union-float-tensorplay-tensor-none-none-source" aria-label="Permalink to &quot;`update(self, new_scale: &#39;Optional[Union[float, tensorplay.Tensor]]&#39; = None) -&gt; &#39;None&#39;` [[source]](https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/grad_scaler.py#L473)&quot;">​</a></h4><p>Update the scale factor.</p><p>If any optimizer steps were skipped the scale is multiplied by <code>backoff_factor</code> to reduce it. If <code>growth_interval</code> unskipped iterations occurred consecutively, the scale is multiplied by <code>growth_factor</code> to increase it.</p><p>Passing <code>new_scale</code> sets the new scale value manually. (<code>new_scale</code> is not used directly, it&#39;s used to fill GradScaler&#39;s internal scale tensor. So if <code>new_scale</code> was a tensor, later in-place changes to that tensor will not further affect the scale GradScaler uses internally.)</p><h4 id="args-8" tabindex="-1">Args <a class="header-anchor" href="#args-8" aria-label="Permalink to &quot;Args&quot;">​</a></h4><ul><li><strong>new_scale</strong> (<code>float or </code>tensorplay.Tensor<code>, optional, default=None</code>): New scale factor.</li></ul><div class="danger custom-block"><p class="custom-block-title">DANGER</p><p><code>update</code> should only be called at the end of the iteration, after <code>scaler.step(optimizer)</code> has been invoked for all optimizers used this iteration.</p></div><div class="danger custom-block"><p class="custom-block-title">DANGER</p><p>For performance reasons, we do not check the scale factor value to avoid synchronizations, so the scale factor is not guaranteed to be above 1. If the scale falls below 1 and/or you are seeing NaNs in your gradients or loss, something is likely wrong. For example, bf16-pretrained models are often incompatible with AMP/fp16 due to differing dynamic ranges.</p></div><hr></details><h3 id="class-autocast-source" tabindex="-1"><code>class autocast</code> <a href="https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/autocast_mode.py#L49" target="_blank" rel="noreferrer">[source]</a> <a class="header-anchor" href="#class-autocast-source" aria-label="Permalink to &quot;`class autocast` [[source]](https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/autocast_mode.py#L49)&quot;">​</a></h3><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">autocast(device_type: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, dtype: Optional[tensorplay.DType] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, enabled: </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">bool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, cache_enabled: Optional[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Instances of <code>autocast</code> serve as context managers or decorators that allow regions of your script to run in mixed precision.</p><p>In these regions, ops run in an op-specific dtype chosen by autocast to improve performance while maintaining accuracy. See the <code>Autocast Op Reference&lt;autocast-op-reference&gt;</code> for details.</p><p>When entering an autocast-enabled region, Tensors may be any type. You should not call <code>half()</code> or <code>bfloat16()</code> on your model(s) or inputs when using autocasting.</p><p><code>autocast</code> should wrap only the forward pass(es) of your network, including the loss computation(s). Backward passes under autocast are not recommended. Backward ops run in the same type that autocast used for corresponding forward ops.</p><p>Example for CUDA Devices</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Creates model and optimizer in default precision</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">model </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Net().cuda()</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">optimizer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> optim.SGD(model.parameters(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> input</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, target </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data:</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    optimizer.zero_grad()</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Enables autocasting for the forward pass (model + loss)</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.autocast(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">device_type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cuda&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        output </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> model(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">input</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        loss </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> loss_fn(output, target)</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Exits the context manager before backward()</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    loss.backward()</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    optimizer.step()</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>See the <code>Automatic Mixed Precision examples&lt;amp-examples&gt;</code> for usage (along with gradient scaling) in more complex scenarios (e.g., gradient penalty, multiple models/losses, custom autograd functions).</p><p><code>autocast</code> can also be used as a decorator, e.g., on the <code>forward</code> method of your model</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AutocastModel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@tensorplay.autocast</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">device_type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cuda&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> forward</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, input):</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Floating-point Tensors produced in an autocast-enabled region may be <code>float16</code>. After returning to an autocast-disabled region, using them with floating-point Tensors of different dtypes may cause type mismatch errors. If so, cast the Tensor(s) produced in the autocast region back to <code>float32</code> (or other dtype if desired). If a Tensor from the autocast region is already <code>float32</code>, the cast is a no-op, and incurs no additional overhead. CUDA Example</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Creates some tensors in default dtype (here assumed to be float32)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">a_float32 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.rand((</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">device</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cuda&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">b_float32 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.rand((</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">device</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cuda&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">c_float32 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.rand((</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">device</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cuda&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">d_float32 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.rand((</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">device</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cuda&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.autocast(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">device_type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cuda&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # tensorplay.mm is on autocast&#39;s list of ops that should run in float16.</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Inputs are float32, but the op runs in float16 and produces float16 output.</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # No manual casts are required.</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    e_float16 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.mm(a_float32, b_float32)</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Also handles mixed input types</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    f_float16 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.mm(d_float32, e_float16)</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># After exiting autocast, calls f_float16.float() to use with d_float32</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">g_float32 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.mm(d_float32, f_float16.float())</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>CPU Training Example</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Creates model and optimizer in default precision</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">model </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Net()</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">optimizer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> optim.SGD(model.parameters(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> epoch </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> epochs:</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> input</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, target </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data:</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        optimizer.zero_grad()</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # Runs the forward pass with autocasting.</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.autocast(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">device_type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cpu&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dtype</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tensorplay.bfloat16):</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            output </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> model(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">input</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            loss </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> loss_fn(output, target)</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        loss.backward()</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        optimizer.step()</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>CPU Inference Example</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Creates model in default precision</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">model </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Net().eval()</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.autocast(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">device_type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cpu&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dtype</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tensorplay.bfloat16):</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> input</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data:</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # Runs the forward pass with autocasting.</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        output </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> model(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">input</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>CPU Inference Example with Jit Trace</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TestModel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __init__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, input_size, num_classes):</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        super</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">__init__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.fc1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nn.Linear(input_size, num_classes)</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> forward</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, x):</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.fc1(x)</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">input_size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">num_classes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">model </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TestModel(input_size, num_classes).eval()</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># For now, we suggest to disable the Jit Autocast Pass,</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># As the issue: https://github.com/pytensorplay/pytensorplay/issues/75956</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tensorplay._C._jit_set_autocast_mode(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.cpu.amp.autocast(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cache_enabled</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    model </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.jit.trace(model, tensorplay.randn(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, input_size))</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">model </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.jit.freeze(model)</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Models Run</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> range</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    model(tensorplay.randn(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, input_size))</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>Type mismatch errors <em>in</em> an autocast-enabled region are a bug; if this is what you observe, please file an issue.</p><p><code>autocast(enabled=False)</code> subregions can be nested in autocast-enabled regions. Locally disabling autocast can be useful, for example, if you want to force a subregion to run in a particular <code>dtype</code>. Disabling autocast gives you explicit control over the execution type. In the subregion, inputs from the surrounding region should be cast to <code>dtype</code> before use</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Creates some tensors in default dtype (here assumed to be float32)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">a_float32 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.rand((</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">device</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cuda&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">b_float32 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.rand((</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">device</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cuda&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">c_float32 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.rand((</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">device</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cuda&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">d_float32 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.rand((</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">device</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cuda&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.autocast(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">device_type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cuda&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    e_float16 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.mm(a_float32, b_float32)</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.autocast(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">device_type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cuda&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">enabled</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # Calls e_float16.float() to ensure float32 execution</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # (necessary because e_float16 was created in an autocasted region)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        f_float32 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.mm(c_float32, e_float16.float())</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # No manual casts are required when re-entering the autocast-enabled region.</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # tensorplay.mm again runs in float16 and produces float16 output, regardless of input types.</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    g_float16 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tensorplay.mm(d_float32, f_float32)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>The autocast state is thread-local. If you want it enabled in a new thread, the context manager or decorator must be invoked in that thread. This affects <code>tensorplay.nn.DataParallel</code> and <code>tensorplay.nn.parallel.DistributedDataParallel</code> when used with more than one GPU per process (see <code>Working with Multiple GPUs&lt;amp-multigpu&gt;</code>).</p><h4 id="args-9" tabindex="-1">Args <a class="header-anchor" href="#args-9" aria-label="Permalink to &quot;Args&quot;">​</a></h4><ul><li><strong>device_type</strong> (<code>str, required</code>): Device type to use. Possible values are: &#39;cuda&#39;, &#39;cpu&#39;, &#39;mtia&#39;, &#39;maia&#39;, &#39;xpu&#39;, and &#39;hpu&#39;. The type is the same as the <code>type</code> attribute of a <code>tensorplay.device</code>. Thus, you may obtain the device type of a tensor using <code>Tensor.device.type</code>.</li><li><strong>enabled</strong> (<code>bool, optional</code>): Whether autocasting should be enabled in the region.</li><li><strong>Default</strong>: <code>True</code></li><li><strong>dtype</strong> (<code>tensorplay_dtype, optional</code>): Data type for ops run in autocast. It uses the default value (<code>tensorplay.float16</code> for CUDA and <code>tensorplay.bfloat16</code> for CPU), given by <code>~tensorplay.get_autocast_dtype</code>, if <code>dtype</code> is <code>None</code>.</li><li><strong>Default</strong>: <code>None</code></li><li><strong>cache_enabled</strong> (<code>bool, optional</code>): Whether the weight cache inside autocast should be enabled.</li><li><strong>Default</strong>: <code>True</code></li></ul><details><summary>Methods</summary><h4 id="init-self-device-type-str-dtype-optional-tensorplay-dtype-none-enabled-bool-true-cache-enabled-optional-bool-none-source" tabindex="-1"><code>__init__(self, device_type: str, dtype: Optional[tensorplay.DType] = None, enabled: bool = True, cache_enabled: Optional[bool] = None)</code> <a href="https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/autocast_mode.py#L217" target="_blank" rel="noreferrer">[source]</a> <a class="header-anchor" href="#init-self-device-type-str-dtype-optional-tensorplay-dtype-none-enabled-bool-true-cache-enabled-optional-bool-none-source" aria-label="Permalink to &quot;`__init__(self, device_type: str, dtype: Optional[tensorplay.DType] = None, enabled: bool = True, cache_enabled: Optional[bool] = None)` [[source]](https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/autocast_mode.py#L217)&quot;">​</a></h4><p>Initialize self. See help(type(self)) for accurate signature.</p><hr></details><h2 id="functions" tabindex="-1">Functions <a class="header-anchor" href="#functions" aria-label="Permalink to &quot;Functions&quot;">​</a></h2><h3 id="custom-bwd-source" tabindex="-1"><code>custom_bwd()</code> <a href="https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/autocast_mode.py#L535" target="_blank" rel="noreferrer">[source]</a> <a class="header-anchor" href="#custom-bwd-source" aria-label="Permalink to &quot;`custom_bwd()` [[source]](https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/autocast_mode.py#L535)&quot;">​</a></h3><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">custom_bwd(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">bwd</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, device_type: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Create a helper decorator for backward methods of custom autograd functions.</p><p>Autograd functions are subclasses of <code>tensorplay.autograd.Function</code>. Ensures that <code>backward</code> executes with the same autocast state as <code>forward</code>. See the <code>example page&lt;amp-custom-examples&gt;</code> for more detail.</p><h4 id="args-10" tabindex="-1">Args <a class="header-anchor" href="#args-10" aria-label="Permalink to &quot;Args&quot;">​</a></h4><ul><li><strong>device_type</strong> (<code>str</code>): Device type to use. &#39;cuda&#39;, &#39;cpu&#39;, &#39;mtia&#39;, &#39;maia&#39;, &#39;xpu&#39; and so on. The type is the same as the <code>type</code> attribute of a <code>tensorplay.device</code>. Thus, you may obtain the device type of a tensor using <code>Tensor.device.type</code>.</li></ul><h3 id="custom-fwd-source" tabindex="-1"><code>custom_fwd()</code> <a href="https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/autocast_mode.py#L476" target="_blank" rel="noreferrer">[source]</a> <a class="header-anchor" href="#custom-fwd-source" aria-label="Permalink to &quot;`custom_fwd()` [[source]](https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/autocast_mode.py#L476)&quot;">​</a></h3><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">custom_fwd(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">fwd</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, device_type: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, cast_inputs: Optional[tensorplay.DType] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Create a helper decorator for <code>forward</code> methods of custom autograd functions.</p><p>Autograd functions are subclasses of <code>tensorplay.autograd.Function</code>. See the <code>example page&lt;amp-custom-examples&gt;</code> for more detail.</p><h4 id="args-11" tabindex="-1">Args <a class="header-anchor" href="#args-11" aria-label="Permalink to &quot;Args&quot;">​</a></h4><ul><li><strong>device_type</strong> (<code>str</code>): Device type to use. &#39;cuda&#39;, &#39;cpu&#39;, &#39;mtia&#39;, &#39;maia&#39;, &#39;xpu&#39; and so on. The type is the same as the <code>type</code> attribute of a <code>tensorplay.device</code>. Thus, you may obtain the device type of a tensor using <code>Tensor.device.type</code>.</li><li><strong>cast_inputs</strong> (<code>tensorplay.dtype` or None, optional, default=None`): If not </code>None<code>, when </code>forward<code>runs in an autocast-enabled region, casts incoming floating-point Tensors to the target dtype (non-floating-point Tensors are not affected), then executes</code>forward<code>with autocast disabled. If</code>None<code>, </code>forward``&#39;s internal ops execute with the current autocast state.</li></ul><div class="info custom-block"><p class="custom-block-title">INFO</p><p>If the decorated <code>forward</code> is called outside an autocast-enabled region, <code>custom_fwd&lt;custom_fwd&gt;</code> is a no-op and <code>cast_inputs</code> has no effect.</p></div><h3 id="is-autocast-available-source" tabindex="-1"><code>is_autocast_available()</code> <a href="https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/autocast_mode.py#L26" target="_blank" rel="noreferrer">[source]</a> <a class="header-anchor" href="#is-autocast-available-source" aria-label="Permalink to &quot;`is_autocast_available()` [[source]](https://github.com/bluemoon-o2/tensorplay/blob/main/tensorplay/amp/autocast_mode.py#L26)&quot;">​</a></h3><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">is_autocast_available(device_type: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">-&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> bool</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Return a bool indicating if autocast is available on <code>device_type</code>.</p><h4 id="args-12" tabindex="-1">Args <a class="header-anchor" href="#args-12" aria-label="Permalink to &quot;Args&quot;">​</a></h4><ul><li><strong>device_type</strong> (<code>str</code>): Device type to use. Possible values are: &#39;cuda&#39;, &#39;cpu&#39;, &#39;mtia&#39;, &#39;maia&#39;, &#39;xpu&#39;, and so on. The type is the same as the <code>type</code> attribute of a <code>tensorplay.device</code>. Thus, you may obtain the device type of a tensor using <code>Tensor.device.type</code>.</li></ul>',62)])])}]]);export{n as __pageData,t as default};
